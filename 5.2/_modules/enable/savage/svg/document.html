<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8">
    
    <title>enable.savage.svg.document &mdash; enable 5.2.0 documentation</title>
    
    <link rel="stylesheet" type="text/css" href="../../../../_static/css/spc-bootstrap.css">
    <link rel="stylesheet" type="text/css" href="../../../../_static/css/spc-extend.css">
    <link rel="stylesheet" href="../../../../_static/enthought.css" type="text/css" >
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" >
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../',
        VERSION:     '5.2.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        LINK_SUFFIX: '',
        SOURCELINK_SUFFIX: '.txt',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../../_static/language_data.js"></script>
    <script type="text/javascript" src="../../../../_static/js/copybutton.js"></script>
    <script type="text/javascript" src="../../../../_static/js/wrap_on_dot.js"></script>
    <link rel="shortcut icon" href="../../../../_static/img/favicon.ico">
    <link rel="index" title="Index" href="../../../../genindex.html" >
    <link rel="search" title="Search" href="../../../../search.html" >
    <link rel="top" title="enable 5.2.0 documentation" href="../../../../index.html" >
    <link rel="up" title="Module code" href="../../../index.html" > 
  </head>
  <body>
  <div class="container">
    <div class="header">
    </div>
  </div>

    <div class="container">
      <div class="main">
        
	<div class="row-fluid">
	  <div class="span12">
	    <div class="spc-navbar">
              
    <ul class="nav nav-pills pull-left">
	
        <li class="active"><a href="../../../../index.html">enable 5.2.0 documentation</a></li>
	
          <li class="active"><a href="../../../index.html" accesskey="U">Module code</a></li> 
    </ul>
              
              
    <ul class="nav nav-pills pull-right">
      <li class="active">
        <a href="../../../../genindex.html" title="General Index"
           accesskey="I">index</a>
      </li>
      <li class="active">
        <a href="../../../../py-modindex.html" title="Python Module Index"
           >modules</a>
      </li>
    </ul>
              
	    </div>
	  </div>
	</div>
        

	<div class="row-fluid">
          <div class="span9">
            
        <div class="bodywrapper">
          <div class="body" id="spc-section-body" role="main">
            
  <h1>Source code for enable.savage.svg.document</h1><div class="highlight"><pre>
<span></span><span class="c1"># (C) Copyright 2005-2021 Enthought, Inc., Austin, TX</span>
<span class="c1"># All rights reserved.</span>
<span class="c1">#</span>
<span class="c1"># This software is provided without warranty under the terms of the BSD</span>
<span class="c1"># license included in LICENSE.txt and may be redistributed only under</span>
<span class="c1"># the conditions described in the aforementioned license. The license</span>
<span class="c1"># is also available online at http://www.enthought.com/licenses/BSD.txt</span>
<span class="c1">#</span>
<span class="c1"># Thanks for using Enthought open source!</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    SVGDocument</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">BytesIO</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">wraps</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">import</span> <span class="nn">urllib.request</span>
<span class="kn">import</span> <span class="nn">urllib.parse</span> <span class="k">as</span> <span class="nn">urlparse</span>
<span class="kn">from</span> <span class="nn">xml.etree</span> <span class="kn">import</span> <span class="n">cElementTree</span> <span class="k">as</span> <span class="n">ET</span>
<span class="kn">from</span> <span class="nn">xml.etree.cElementTree</span> <span class="kn">import</span> <span class="n">ParseError</span>


<span class="kn">import</span> <span class="nn">numpy</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">css</span>
<span class="kn">from</span> <span class="nn">.css.colour</span> <span class="kn">import</span> <span class="n">colourValue</span>
<span class="kn">from</span> <span class="nn">.css</span> <span class="kn">import</span> <span class="n">values</span>
<span class="kn">from</span> <span class="nn">.attributes</span> <span class="kn">import</span> <span class="n">paintValue</span>
<span class="kn">from</span> <span class="nn">.svg_regex</span> <span class="kn">import</span> <span class="n">svg_parser</span>

<span class="kn">from</span> <span class="nn">enable.savage.svg.backends.null.null_renderer</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">NullRenderer</span><span class="p">,</span>
    <span class="n">AbstractGradientBrush</span><span class="p">,</span>
<span class="p">)</span>


<div class="viewcode-block" id="XMLNS"><a class="viewcode-back" href="../../../../api/enable.savage.svg.document.html#enable.savage.svg.document.XMLNS">[docs]</a><span class="k">class</span> <span class="nc">XMLNS</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Utility object for dealing the namespaced names quoted the way</span>
<span class="sd">    ElementTree requires.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__url</span> <span class="o">=</span> <span class="n">url</span>

    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;{</span><span class="si">%s</span><span class="s2">}</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__url</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span></div>


<span class="n">XLink</span> <span class="o">=</span> <span class="n">XMLNS</span><span class="p">(</span><span class="s2">&quot;http://www.w3.org/1999/xlink&quot;</span><span class="p">)</span>
<span class="n">XML</span> <span class="o">=</span> <span class="n">XMLNS</span><span class="p">(</span><span class="s2">&quot;http://www.w3.org/XML/1998/namespace&quot;</span><span class="p">)</span>
<span class="n">SVG</span> <span class="o">=</span> <span class="n">XMLNS</span><span class="p">(</span><span class="s2">&quot;http://www.w3.org/2000/svg&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="normalize_href"><a class="viewcode-back" href="../../../../api/enable.savage.svg.document.html#enable.savage.svg.document.normalize_href">[docs]</a><span class="k">def</span> <span class="nf">normalize_href</span><span class="p">(</span><span class="n">href</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Normalize an href to remove url(...) and xpointer(id(...)) extraneous</span>
<span class="sd">    bits.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    href : str</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    uri : str</span>
<span class="sd">        A URI (or maybe a file system path) to the resource.</span>
<span class="sd">    fragment : str</span>
<span class="sd">        The normalized #fragment, if any</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">href</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;url(&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">href</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;)&quot;</span><span class="p">):</span>
        <span class="n">href</span> <span class="o">=</span> <span class="n">href</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">scheme</span><span class="p">,</span> <span class="n">netloc</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">fragment</span> <span class="o">=</span> <span class="n">urlparse</span><span class="o">.</span><span class="n">urlparse</span><span class="p">(</span><span class="n">href</span><span class="p">)</span>
    <span class="c1"># Normalize xpointer(id(...)) references.</span>
    <span class="k">if</span> <span class="n">fragment</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;xpointer(id(&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">fragment</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;))&quot;</span><span class="p">):</span>
        <span class="c1"># FIXME: whitespace?</span>
        <span class="n">fragment</span> <span class="o">=</span> <span class="n">fragment</span><span class="p">[</span><span class="mi">12</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">uri</span> <span class="o">=</span> <span class="n">urlparse</span><span class="o">.</span><span class="n">urlunparse</span><span class="p">((</span><span class="n">scheme</span><span class="p">,</span> <span class="n">netloc</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">uri</span><span class="p">,</span> <span class="n">fragment</span></div>


<div class="viewcode-block" id="attrAsFloat"><a class="viewcode-back" href="../../../../api/enable.savage.svg.document.html#enable.savage.svg.document.attrAsFloat">[docs]</a><span class="k">def</span> <span class="nf">attrAsFloat</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">defaultValue</span><span class="o">=</span><span class="s2">&quot;0&quot;</span><span class="p">):</span>
    <span class="n">val</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">defaultValue</span><span class="p">)</span>
    <span class="c1"># TODO: process stuff like &quot;inherit&quot; by walking back up the nodes</span>
    <span class="c1"># fast path optimization - if it&#39;s a valid float, don&#39;t</span>
    <span class="c1"># try to parse it.</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">valueToPixels</span><span class="p">(</span><span class="n">val</span><span class="p">)</span></div>


<div class="viewcode-block" id="fractionalValue"><a class="viewcode-back" href="../../../../api/enable.savage.svg.document.html#enable.savage.svg.document.fractionalValue">[docs]</a><span class="k">def</span> <span class="nf">fractionalValue</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Parse a string consisting of a float in the range [0..1] or a</span>
<span class="sd">    percentage as a float number in the range [0..1].</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;%&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mf">100.0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></div>


<span class="n">units_to_px</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;in&quot;</span><span class="p">:</span> <span class="mi">72</span><span class="p">,</span>
    <span class="s2">&quot;pc&quot;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span>
    <span class="s2">&quot;cm&quot;</span><span class="p">:</span> <span class="mf">72.0</span> <span class="o">/</span> <span class="mf">2.54</span><span class="p">,</span>
    <span class="s2">&quot;mm&quot;</span><span class="p">:</span> <span class="mf">72.0</span> <span class="o">/</span> <span class="mf">25.4</span><span class="p">,</span>
    <span class="s2">&quot;px&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;pt&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">}</span>


<div class="viewcode-block" id="valueToPixels"><a class="viewcode-back" href="../../../../api/enable.savage.svg.document.html#enable.savage.svg.document.valueToPixels">[docs]</a><span class="k">def</span> <span class="nf">valueToPixels</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">defaultUnits</span><span class="o">=</span><span class="s2">&quot;px&quot;</span><span class="p">):</span>
    <span class="c1"># This pretends that 1px == 1pt. For our purposes, that&#39;s fine since we</span>
    <span class="c1"># don&#39;t actually care about px. The name of the function is bad.</span>
    <span class="c1"># TODO: refactor in order to handle relative percentages and em and ex.</span>
    <span class="c1"># TODO: manage default units</span>
    <span class="kn">from</span> <span class="nn">pyparsing</span> <span class="kn">import</span> <span class="n">ParseException</span>

    <span class="k">if</span> <span class="n">val</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;%&quot;</span><span class="p">):</span>
        <span class="c1"># TODO: this is one of those relative values we need to fix.</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">val</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mf">100.0</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">val</span><span class="p">,</span> <span class="n">unit</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">length</span><span class="o">.</span><span class="n">parseString</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">ParseException</span><span class="p">:</span>
        <span class="k">raise</span>
    <span class="n">val</span> <span class="o">*=</span> <span class="n">units_to_px</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">val</span></div>


<div class="viewcode-block" id="pathHandler"><a class="viewcode-back" href="../../../../api/enable.savage.svg.document.html#enable.savage.svg.document.pathHandler">[docs]</a><span class="k">def</span> <span class="nf">pathHandler</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;decorator for methods which return a path operation</span>
<span class="sd">        Creates the path they will fill,</span>
<span class="sd">        and generates the path operations for the node</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">inner</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">renderer</span><span class="o">.</span><span class="n">makePath</span><span class="p">()</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>

        <span class="n">ops</span> <span class="o">=</span> <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">renderer</span><span class="o">.</span><span class="n">pushState</span><span class="p">,</span> <span class="p">())]</span>

        <span class="c1"># the results willbe None, unless the path has something which affects</span>
        <span class="c1"># the render stack, such as clipping</span>
        <span class="k">if</span> <span class="n">results</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cpath</span><span class="p">,</span> <span class="n">cops</span> <span class="o">=</span> <span class="n">results</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">cpath</span>
            <span class="n">ops</span> <span class="o">=</span> <span class="n">cops</span> <span class="o">+</span> <span class="n">ops</span>

        <span class="n">ops</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">createTransformOpsFromNode</span><span class="p">(</span><span class="n">node</span><span class="p">))</span>
        <span class="n">ops</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">generatePathOps</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
        <span class="n">ops</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">renderer</span><span class="o">.</span><span class="n">popState</span><span class="p">,</span> <span class="p">()))</span>
        <span class="k">return</span> <span class="n">path</span><span class="p">,</span> <span class="n">ops</span>

    <span class="k">return</span> <span class="n">inner</span></div>


<div class="viewcode-block" id="ResourceGetter"><a class="viewcode-back" href="../../../../api/enable.savage.svg.document.html#enable.savage.svg.document.ResourceGetter">[docs]</a><span class="k">class</span> <span class="nc">ResourceGetter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Simple context for getting relative-pathed resources.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dirname</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">dirname</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dirname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dirname</span> <span class="o">=</span> <span class="n">dirname</span>

<div class="viewcode-block" id="ResourceGetter.fromfilename"><a class="viewcode-back" href="../../../../api/enable.savage.svg.document.html#enable.savage.svg.document.ResourceGetter.fromfilename">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">fromfilename</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Use the directory containing this file as the base directory.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dirname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">dirname</span><span class="p">)</span></div>

<div class="viewcode-block" id="ResourceGetter.newbase"><a class="viewcode-back" href="../../../../api/enable.savage.svg.document.html#enable.savage.svg.document.ResourceGetter.newbase">[docs]</a>    <span class="k">def</span> <span class="nf">newbase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dirname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return a new ResourceGetter using a new base directory found</span>
<span class="sd">        relative to this one.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dirname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dirname</span><span class="p">,</span> <span class="n">dirname</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">dirname</span><span class="p">)</span></div>

<div class="viewcode-block" id="ResourceGetter.resolve"><a class="viewcode-back" href="../../../../api/enable.savage.svg.document.html#enable.savage.svg.document.ResourceGetter.resolve">[docs]</a>    <span class="k">def</span> <span class="nf">resolve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Resolve a path and the associated opener function against this</span>
<span class="sd">        context.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">scheme</span><span class="p">,</span> <span class="n">netloc</span><span class="p">,</span> <span class="n">path_part</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">urlparse</span><span class="o">.</span><span class="n">urlparse</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">scheme</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;file&quot;</span><span class="p">):</span>
            <span class="c1"># Plain URI. Pass it back.</span>
            <span class="c1"># Read the data and stuff it in a StringIO in order to satisfy</span>
            <span class="c1"># functions that need a functioning seek() and stuff.</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="n">path</span><span class="p">,</span>
                <span class="k">lambda</span> <span class="n">uri</span><span class="p">:</span> <span class="n">BytesIO</span><span class="p">(</span><span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()),</span>
            <span class="p">)</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dirname</span><span class="p">,</span> <span class="n">path_part</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">path</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">fn</span><span class="p">:</span> <span class="nb">open</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="ResourceGetter.open_svg"><a class="viewcode-back" href="../../../../api/enable.savage.svg.document.html#enable.savage.svg.document.ResourceGetter.open_svg">[docs]</a>    <span class="k">def</span> <span class="nf">open_svg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Resolve and read an SVG file into an Element.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">path</span><span class="p">,</span> <span class="nb">open</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">tree</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="n">element</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">element</span></div>

<div class="viewcode-block" id="ResourceGetter.open_image"><a class="viewcode-back" href="../../../../api/enable.savage.svg.document.html#enable.savage.svg.document.ResourceGetter.open_image">[docs]</a>    <span class="k">def</span> <span class="nf">open_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Resolve and read an image into an appropriate object for the</span>
<span class="sd">        renderer.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">numpy</span>
        <span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>

        <span class="n">path</span><span class="p">,</span> <span class="nb">open</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">as</span> <span class="n">fin</span><span class="p">:</span>
            <span class="n">pil_img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fin</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">pil_img</span><span class="o">.</span><span class="n">mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;RGB&quot;</span><span class="p">,</span> <span class="s2">&quot;RGBA&quot;</span><span class="p">):</span>
            <span class="n">pil_img</span> <span class="o">=</span> <span class="n">pil_img</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s2">&quot;RGBA&quot;</span><span class="p">)</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">pil_img</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">img</span></div></div>


<div class="viewcode-block" id="SVGDocument"><a class="viewcode-back" href="../../../../api/enable.savage.svg.document.html#enable.savage.svg.document.SVGDocument">[docs]</a><span class="k">class</span> <span class="nc">SVGDocument</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="p">,</span> <span class="n">resources</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">renderer</span><span class="o">=</span><span class="n">NullRenderer</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create an SVG document from an ElementTree node.</span>

<span class="sd">        FIXME: this is really wrong that the doc must know about the renderer</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">renderer</span> <span class="o">=</span> <span class="n">renderer</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lastControl</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">brushCache</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">penCache</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">SVG</span><span class="o">.</span><span class="n">svg</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">addGroupToDocument</span><span class="p">,</span>
            <span class="n">SVG</span><span class="o">.</span><span class="n">a</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">addGroupToDocument</span><span class="p">,</span>
            <span class="n">SVG</span><span class="o">.</span><span class="n">g</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">addGroupToDocument</span><span class="p">,</span>
            <span class="n">SVG</span><span class="o">.</span><span class="n">symbol</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">addGroupToDocument</span><span class="p">,</span>
            <span class="n">SVG</span><span class="o">.</span><span class="n">use</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">addUseToDocument</span><span class="p">,</span>
            <span class="n">SVG</span><span class="o">.</span><span class="n">switch</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">addSwitchToDocument</span><span class="p">,</span>
            <span class="n">SVG</span><span class="o">.</span><span class="n">image</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">addImageToDocument</span><span class="p">,</span>
            <span class="n">SVG</span><span class="o">.</span><span class="n">rect</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">addRectToDocument</span><span class="p">,</span>
            <span class="n">SVG</span><span class="o">.</span><span class="n">circle</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">addCircleToDocument</span><span class="p">,</span>
            <span class="n">SVG</span><span class="o">.</span><span class="n">ellipse</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">addEllipseToDocument</span><span class="p">,</span>
            <span class="n">SVG</span><span class="o">.</span><span class="n">line</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">addLineToDocument</span><span class="p">,</span>
            <span class="n">SVG</span><span class="o">.</span><span class="n">polyline</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">addPolyLineToDocument</span><span class="p">,</span>
            <span class="n">SVG</span><span class="o">.</span><span class="n">polygon</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">addPolygonToDocument</span><span class="p">,</span>
            <span class="n">SVG</span><span class="o">.</span><span class="n">path</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">addPathDataToDocument</span><span class="p">,</span>
            <span class="n">SVG</span><span class="o">.</span><span class="n">text</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">addTextToDocument</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">assert</span> <span class="n">element</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="n">SVG</span><span class="o">.</span><span class="n">svg</span><span class="p">,</span> <span class="s2">&quot;Not an SVG fragment&quot;</span>
        <span class="k">if</span> <span class="n">resources</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">resources</span> <span class="o">=</span> <span class="n">ResourceGetter</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resources</span> <span class="o">=</span> <span class="n">resources</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tree</span> <span class="o">=</span> <span class="n">element</span>
        <span class="c1"># Mapping of (URI, XML id) pairs to elements. &#39;&#39; is the URI for local</span>
        <span class="c1"># resources. Use self.update(findIDs(element), uri) for adding elements</span>
        <span class="c1"># from other URIs.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">idmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">findIDs</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">paths</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stateStack</span> <span class="o">=</span> <span class="p">[{}]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clippingStack</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">path</span><span class="p">,</span> <span class="n">ops</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">processElement</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ops</span> <span class="o">=</span> <span class="n">ops</span>

<div class="viewcode-block" id="SVGDocument.createFromFile"><a class="viewcode-back" href="../../../../api/enable.savage.svg.document.html#enable.savage.svg.document.SVGDocument.createFromFile">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">createFromFile</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">renderer</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;No such file: &quot;</span> <span class="o">+</span> <span class="n">filename</span><span class="p">)</span>

        <span class="n">tree</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span>

        <span class="n">resources</span> <span class="o">=</span> <span class="n">ResourceGetter</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">resources</span><span class="p">,</span> <span class="n">renderer</span><span class="p">)</span></div>

<div class="viewcode-block" id="SVGDocument.getSize"><a class="viewcode-back" href="../../../../api/enable.savage.svg.document.html#enable.savage.svg.document.SVGDocument.getSize">[docs]</a>    <span class="k">def</span> <span class="nf">getSize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">width</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">width_node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">width_node</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">width_node</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;cm&quot;</span><span class="p">):</span>
                <span class="c1"># assumes dpi of 72</span>
                <span class="n">width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">width_node</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;cm&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="mi">72</span> <span class="o">/</span> <span class="mf">2.54</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># omit &#39;px&#39; if it was specified</span>
                <span class="n">width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">width_node</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;px&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>

        <span class="n">height</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">height_node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">height_node</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">height_node</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;cm&quot;</span><span class="p">):</span>
                <span class="c1"># assumes dpi of 72</span>
                <span class="n">height</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">height_node</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;cm&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="mi">72</span> <span class="o">/</span> <span class="mf">2.54</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># omit &#39;px&#39; if it was specified</span>
                <span class="n">height</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">height_node</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;px&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span></div>

<div class="viewcode-block" id="SVGDocument.findIDs"><a class="viewcode-back" href="../../../../api/enable.savage.svg.document.html#enable.savage.svg.document.SVGDocument.findIDs">[docs]</a>    <span class="k">def</span> <span class="nf">findIDs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="p">,</span> <span class="n">uri</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Iterate through the tree under an element and record all elements</span>
<span class="sd">        which specify an id attribute.</span>

<span class="sd">        The root element is given the ID &#39;&#39; in addition to whatever id=</span>
<span class="sd">        attribute it may be given.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">idmap</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="n">iter</span><span class="p">():</span>
            <span class="nb">id</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">idmap</span><span class="p">[(</span><span class="n">uri</span><span class="p">,</span> <span class="nb">id</span><span class="p">)]</span> <span class="o">=</span> <span class="n">e</span>
        <span class="n">idmap</span><span class="p">[(</span><span class="n">uri</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">element</span>
        <span class="k">return</span> <span class="n">idmap</span></div>

<div class="viewcode-block" id="SVGDocument.dereference"><a class="viewcode-back" href="../../../../api/enable.savage.svg.document.html#enable.savage.svg.document.SVGDocument.dereference">[docs]</a>    <span class="k">def</span> <span class="nf">dereference</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">href</span><span class="p">,</span> <span class="n">resources</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Find the element specified by the give href.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        href : str</span>
<span class="sd">            The reference pointing to the desired element. Forms like</span>
<span class="sd">            &#39;url(uri#theid)&#39; and &#39;uri#xpointer(id(theid))&#39; will be normalized</span>
<span class="sd">            to pull out just the uri and the id.</span>
<span class="sd">        resources : ResourceGetter, optional</span>
<span class="sd">            The ResourceGetter to use. If not provided, the one attached to the</span>
<span class="sd">            SVGDocument is used. This is useful when silly test suites like to</span>
<span class="sd">            test annoying XLink features.</span>
<span class="sd">            FIXME: &lt;sigh&gt; xml:base is inheritable.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        element : Element</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        KeyError :</span>
<span class="sd">            If the element is not found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">uri</span><span class="p">,</span> <span class="n">fragment</span> <span class="o">=</span> <span class="n">normalize_href</span><span class="p">(</span><span class="n">href</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">uri</span> <span class="ow">and</span> <span class="p">(</span><span class="n">uri</span><span class="p">,</span> <span class="n">fragment</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">idmap</span><span class="p">:</span>
            <span class="c1"># Record all of the IDed elements in the referenced document.</span>
            <span class="k">if</span> <span class="n">resources</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">resources</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resources</span>
            <span class="n">element</span> <span class="o">=</span> <span class="n">resources</span><span class="o">.</span><span class="n">open_svg</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">idmap</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">findIDs</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">uri</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">idmap</span><span class="p">[(</span><span class="n">uri</span><span class="p">,</span> <span class="n">fragment</span><span class="p">)]</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Retrieve the current state, without popping&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">stateStack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

<div class="viewcode-block" id="SVGDocument.getLocalState"><a class="viewcode-back" href="../../../../api/enable.savage.svg.document.html#enable.savage.svg.document.SVGDocument.getLocalState">[docs]</a>    <span class="k">def</span> <span class="nf">getLocalState</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get the state local to an element.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">state</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span>
        <span class="n">current</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
        <span class="n">element_items</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="o">!=</span> <span class="s2">&quot;inherit&quot;</span>
        <span class="p">]</span>
        <span class="n">current</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">element_items</span><span class="p">)</span>
        <span class="n">style_items</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="n">css</span><span class="o">.</span><span class="n">inlineStyle</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;style&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">v</span> <span class="o">!=</span> <span class="s2">&quot;inherit&quot;</span>
        <span class="p">]</span>
        <span class="n">current</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">style_items</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">current</span></div>

<div class="viewcode-block" id="SVGDocument.processElement"><a class="viewcode-back" href="../../../../api/enable.savage.svg.document.html#enable.savage.svg.document.SVGDocument.processElement">[docs]</a>    <span class="k">def</span> <span class="nf">processElement</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Process one element of the XML tree.</span>
<span class="sd">        Returns the path representing the node,</span>
<span class="sd">        and an operation list for drawing the node.</span>

<span class="sd">        Parent nodes should return a path (for hittesting), but</span>
<span class="sd">        no draw operations</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">current</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getLocalState</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stateStack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current</span><span class="p">)</span>
        <span class="n">handler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">tag</span><span class="p">,</span> <span class="k">lambda</span> <span class="o">*</span><span class="nb">any</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        <span class="n">path</span><span class="p">,</span> <span class="n">ops</span> <span class="o">=</span> <span class="n">handler</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="n">element</span><span class="p">]</span> <span class="o">=</span> <span class="n">path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stateStack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">path</span><span class="p">,</span> <span class="n">ops</span></div>

<div class="viewcode-block" id="SVGDocument.createTransformOpsFromNode"><a class="viewcode-back" href="../../../../api/enable.savage.svg.document.html#enable.savage.svg.document.SVGDocument.createTransformOpsFromNode">[docs]</a>    <span class="k">def</span> <span class="nf">createTransformOpsFromNode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">attribute</span><span class="o">=</span><span class="s2">&quot;transform&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns an oplist for transformations.</span>
<span class="sd">        This applies to a node, not the current state because</span>
<span class="sd">        the transform stack is saved in the graphics context.</span>

<span class="sd">        This oplist does *not* include the push/pop state commands</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ops</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">transform</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attribute</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="c1"># todo: replace this with a mapping list</span>
        <span class="k">if</span> <span class="n">transform</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">transform</span><span class="p">,</span> <span class="n">args</span> <span class="ow">in</span> <span class="n">css</span><span class="o">.</span><span class="n">transformList</span><span class="o">.</span><span class="n">parseString</span><span class="p">(</span><span class="n">transform</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">transform</span> <span class="o">==</span> <span class="s2">&quot;scale&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">x</span> <span class="o">=</span> <span class="n">y</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">args</span>
                    <span class="n">ops</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">renderer</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)))</span>
                <span class="k">if</span> <span class="n">transform</span> <span class="o">==</span> <span class="s2">&quot;translate&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">x</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">y</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">args</span>
                    <span class="n">ops</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">renderer</span><span class="o">.</span><span class="n">translate</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)))</span>
                <span class="k">if</span> <span class="n">transform</span> <span class="o">==</span> <span class="s2">&quot;rotate&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                        <span class="n">angle</span><span class="p">,</span> <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span> <span class="o">=</span> <span class="n">args</span>
                        <span class="n">angle</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
                        <span class="n">ops</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                            <span class="p">[</span>
                                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">renderer</span><span class="o">.</span><span class="n">translate</span><span class="p">,</span> <span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">)),</span>
                                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">renderer</span><span class="o">.</span><span class="n">rotate</span><span class="p">,</span> <span class="p">(</span><span class="n">angle</span><span class="p">,)),</span>
                                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">renderer</span><span class="o">.</span><span class="n">translate</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="n">cx</span><span class="p">,</span> <span class="o">-</span><span class="n">cy</span><span class="p">)),</span>
                            <span class="p">]</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">angle</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">angle</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
                        <span class="n">ops</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">renderer</span><span class="o">.</span><span class="n">rotate</span><span class="p">,</span> <span class="p">(</span><span class="n">angle</span><span class="p">,)))</span>
                <span class="k">if</span> <span class="n">transform</span> <span class="o">==</span> <span class="s2">&quot;matrix&quot;</span><span class="p">:</span>
                    <span class="n">matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">renderer</span><span class="o">.</span><span class="n">createAffineMatrix</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
                    <span class="n">ops</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">renderer</span><span class="o">.</span><span class="n">concatTransform</span><span class="p">,</span> <span class="p">(</span><span class="n">matrix</span><span class="p">,)))</span>
                <span class="k">if</span> <span class="n">transform</span> <span class="o">==</span> <span class="s2">&quot;skewX&quot;</span><span class="p">:</span>
                    <span class="n">matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">renderer</span><span class="o">.</span><span class="n">createAffineMatrix</span><span class="p">(</span>
                        <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
                    <span class="p">)</span>
                    <span class="n">ops</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">renderer</span><span class="o">.</span><span class="n">concatTransform</span><span class="p">,</span> <span class="p">(</span><span class="n">matrix</span><span class="p">,)))</span>
                <span class="k">if</span> <span class="n">transform</span> <span class="o">==</span> <span class="s2">&quot;skewY&quot;</span><span class="p">:</span>
                    <span class="n">matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">renderer</span><span class="o">.</span><span class="n">createAffineMatrix</span><span class="p">(</span>
                        <span class="mi">1</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
                    <span class="p">)</span>
                    <span class="n">ops</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">renderer</span><span class="o">.</span><span class="n">concatTransform</span><span class="p">,</span> <span class="p">(</span><span class="n">matrix</span><span class="p">,)))</span>
        <span class="k">return</span> <span class="n">ops</span></div>

<div class="viewcode-block" id="SVGDocument.createTransformOpsFromXY"><a class="viewcode-back" href="../../../../api/enable.savage.svg.document.html#enable.savage.svg.document.SVGDocument.createTransformOpsFromXY">[docs]</a>    <span class="k">def</span> <span class="nf">createTransformOpsFromXY</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; On some nodes, x and y attributes cause a translation of the</span>
<span class="sd">        coordinate system.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ops</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Now process x,y attributes. Per 7.6 of the SVG1.1 spec, these are</span>
        <span class="c1"># interpreted after transform=.</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">attrAsFloat</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">attrAsFloat</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">x</span> <span class="o">!=</span> <span class="mf">0.0</span> <span class="ow">or</span> <span class="n">y</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">ops</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">renderer</span><span class="o">.</span><span class="n">translate</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">ops</span></div>

<div class="viewcode-block" id="SVGDocument.addGroupToDocument"><a class="viewcode-back" href="../../../../api/enable.savage.svg.document.html#enable.savage.svg.document.SVGDocument.addGroupToDocument">[docs]</a>    <span class="k">def</span> <span class="nf">addGroupToDocument</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; For parent elements: push on a state,</span>
<span class="sd">        then process all child elements</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ops</span> <span class="o">=</span> <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">renderer</span><span class="o">.</span><span class="n">pushState</span><span class="p">,</span> <span class="p">())]</span>

        <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">renderer</span><span class="o">.</span><span class="n">makePath</span><span class="p">()</span>
        <span class="n">ops</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">createTransformOpsFromNode</span><span class="p">(</span><span class="n">node</span><span class="p">))</span>
        <span class="n">ops</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">createTransformOpsFromXY</span><span class="p">(</span><span class="n">node</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">node</span><span class="p">:</span>
            <span class="n">cpath</span><span class="p">,</span> <span class="n">cops</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">processElement</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cpath</span><span class="p">:</span>
                <span class="n">path</span><span class="o">.</span><span class="n">AddPath</span><span class="p">(</span><span class="n">cpath</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cops</span><span class="p">:</span>
                <span class="n">ops</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">cops</span><span class="p">)</span>
        <span class="n">ops</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">renderer</span><span class="o">.</span><span class="n">popState</span><span class="p">,</span> <span class="p">()))</span>
        <span class="k">return</span> <span class="n">path</span><span class="p">,</span> <span class="n">ops</span></div>

<div class="viewcode-block" id="SVGDocument.addUseToDocument"><a class="viewcode-back" href="../../../../api/enable.savage.svg.document.html#enable.savage.svg.document.SVGDocument.addUseToDocument">[docs]</a>    <span class="k">def</span> <span class="nf">addUseToDocument</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Add a &lt;use&gt; tag to the document.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># FIXME: width,height?</span>
        <span class="c1"># FIXME: this could lead to circular references in erroneous documents.</span>
        <span class="c1"># It would be nice to raise an exception in this case.</span>
        <span class="n">href</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">XLink</span><span class="o">.</span><span class="n">href</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">href</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Links to nothing.</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="p">[]</span>
        <span class="n">base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">XML</span><span class="o">.</span><span class="n">base</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">base</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">resources</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resources</span><span class="o">.</span><span class="n">newbase</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">resources</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resources</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">element</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dereference</span><span class="p">(</span><span class="n">href</span><span class="p">,</span> <span class="n">resources</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="ne">IOError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># SVG file cannot be found.</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;Could not find SVG file </span><span class="si">%s</span><span class="s2">. </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span>
                <span class="o">%</span> <span class="p">(</span><span class="n">href</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="p">[]</span>

        <span class="n">ops</span> <span class="o">=</span> <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">renderer</span><span class="o">.</span><span class="n">pushState</span><span class="p">,</span> <span class="p">())]</span>

        <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">renderer</span><span class="o">.</span><span class="n">makePath</span><span class="p">()</span>
        <span class="n">ops</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">createTransformOpsFromNode</span><span class="p">(</span><span class="n">node</span><span class="p">))</span>
        <span class="n">ops</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">createTransformOpsFromXY</span><span class="p">(</span><span class="n">node</span><span class="p">))</span>
        <span class="n">cpath</span><span class="p">,</span> <span class="n">cops</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">processElement</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cpath</span><span class="p">:</span>
            <span class="n">path</span><span class="o">.</span><span class="n">AddPath</span><span class="p">(</span><span class="n">cpath</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cops</span><span class="p">:</span>
            <span class="n">ops</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">cops</span><span class="p">)</span>
        <span class="n">ops</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">renderer</span><span class="o">.</span><span class="n">popState</span><span class="p">,</span> <span class="p">()))</span>
        <span class="k">return</span> <span class="n">path</span><span class="p">,</span> <span class="n">ops</span></div>

<div class="viewcode-block" id="SVGDocument.addSwitchToDocument"><a class="viewcode-back" href="../../../../api/enable.savage.svg.document.html#enable.savage.svg.document.SVGDocument.addSwitchToDocument">[docs]</a>    <span class="k">def</span> <span class="nf">addSwitchToDocument</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Process a &lt;switch&gt; tag.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">node</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;requiredExtensions&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># This renderer does not support any extensions. Pick the first</span>
                <span class="c1"># item that works. This allows us to read SVG files made with</span>
                <span class="c1"># Adobe Illustrator. They embed the SVG content in a &lt;switch&gt;</span>
                <span class="c1"># along with an encoded representation in AI format. The</span>
                <span class="c1"># encoded non-SVG bit has a requiredExtensions= attribute.</span>
                <span class="c1"># FIXME: other tests?</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">processElement</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="SVGDocument.addImageToDocument"><a class="viewcode-back" href="../../../../api/enable.savage.svg.document.html#enable.savage.svg.document.SVGDocument.addImageToDocument">[docs]</a>    <span class="k">def</span> <span class="nf">addImageToDocument</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Add an &lt;image&gt; tag to the document.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">href</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">XLink</span><span class="o">.</span><span class="n">href</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">href</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Links to nothing.</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="p">[]</span>
        <span class="n">base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">XML</span><span class="o">.</span><span class="n">base</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">base</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">resources</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resources</span><span class="o">.</span><span class="n">newbase</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">resources</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resources</span>
        <span class="n">uri</span><span class="p">,</span> <span class="n">fragment</span> <span class="o">=</span> <span class="n">normalize_href</span><span class="p">(</span><span class="n">href</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">uri</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.svg&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">uri</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;data:&quot;</span><span class="p">):</span>
            <span class="c1"># FIXME: Pretend it&#39;s a &lt;use&gt;.</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">addUseToDocument</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">resources</span><span class="o">.</span><span class="n">open_image</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="ne">IOError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Image cannot be found.</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;Could not find image file </span><span class="si">%s</span><span class="s2">. </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span>
                <span class="o">%</span> <span class="p">(</span><span class="n">uri</span><span class="p">[:</span><span class="mi">100</span><span class="p">],</span> <span class="n">e</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)[:</span><span class="mi">100</span><span class="p">])</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="p">[]</span>
        <span class="n">ops</span> <span class="o">=</span> <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">renderer</span><span class="o">.</span><span class="n">pushState</span><span class="p">,</span> <span class="p">())]</span>
        <span class="n">ops</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">createTransformOpsFromNode</span><span class="p">(</span><span class="n">node</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">image</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;Element&quot;</span><span class="p">:</span>
            <span class="c1"># FIXME: bad API. Bad typecheck since ET.Element is a factory</span>
            <span class="c1"># function, not a type.</span>
            <span class="c1"># This is an SVG file, not an image.</span>
            <span class="n">imgpath</span><span class="p">,</span> <span class="n">imgops</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">processElement</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
            <span class="n">ops</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">imgops</span><span class="p">)</span>
            <span class="n">ops</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">renderer</span><span class="o">.</span><span class="n">popState</span><span class="p">,</span> <span class="p">()))</span>
            <span class="k">return</span> <span class="n">imgpath</span><span class="p">,</span> <span class="n">ops</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">attrAsFloat</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">attrAsFloat</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">)</span>
        <span class="n">width</span> <span class="o">=</span> <span class="n">attrAsFloat</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;width&quot;</span><span class="p">)</span>
        <span class="n">height</span> <span class="o">=</span> <span class="n">attrAsFloat</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;height&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">width</span> <span class="o">==</span> <span class="mf">0.0</span> <span class="ow">or</span> <span class="n">height</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="p">[]</span>
        <span class="n">ops</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">renderer</span><span class="o">.</span><span class="n">DrawImage</span><span class="p">,</span> <span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">)),</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">renderer</span><span class="o">.</span><span class="n">popState</span><span class="p">,</span> <span class="p">()),</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">ops</span></div>

<div class="viewcode-block" id="SVGDocument.getFontFromState"><a class="viewcode-back" href="../../../../api/enable.savage.svg.document.html#enable.savage.svg.document.SVGDocument.getFontFromState">[docs]</a>    <span class="k">def</span> <span class="nf">getFontFromState</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">font</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">renderer</span><span class="o">.</span><span class="n">getFont</span><span class="p">()</span>
        <span class="n">family</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;font-family&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">family</span><span class="p">:</span>
            <span class="n">font</span><span class="o">.</span><span class="n">face_name</span> <span class="o">=</span> <span class="n">family</span>

        <span class="n">style</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;font-style&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">style</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">renderer</span><span class="o">.</span><span class="n">setFontStyle</span><span class="p">(</span><span class="n">font</span><span class="p">,</span> <span class="n">style</span><span class="p">)</span>

        <span class="n">weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;font-weight&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">weight</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">renderer</span><span class="o">.</span><span class="n">setFontWeight</span><span class="p">(</span><span class="n">font</span><span class="p">,</span> <span class="n">weight</span><span class="p">)</span>

        <span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;font-size&quot;</span><span class="p">)</span>
        <span class="c1"># TODO: properly handle inheritance.</span>
        <span class="k">if</span> <span class="n">size</span> <span class="ow">and</span> <span class="n">size</span> <span class="o">!=</span> <span class="s2">&quot;inherit&quot;</span><span class="p">:</span>
            <span class="n">val</span><span class="p">,</span> <span class="n">unit</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">length</span><span class="o">.</span><span class="n">parseString</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">renderer</span><span class="o">.</span><span class="n">setFontSize</span><span class="p">(</span><span class="n">font</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

        <span class="c1"># fixme: Handle text-decoration for line-through and underline.</span>
        <span class="c1">#        These are probably done externally using drawing commands.</span>
        <span class="k">return</span> <span class="n">font</span></div>

<div class="viewcode-block" id="SVGDocument.addTextToDocument"><a class="viewcode-back" href="../../../../api/enable.savage.svg.document.html#enable.savage.svg.document.SVGDocument.addTextToDocument">[docs]</a>    <span class="k">def</span> <span class="nf">addTextToDocument</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="c1"># TODO: these attributes can actually be lists of numbers.</span>
        <span class="c1"># text-text-04-t.svg</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="n">attrAsFloat</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">)]</span>

        <span class="n">font</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getFontFromState</span><span class="p">()</span>
        <span class="n">brush</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getBrushFromState</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">brush</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">brush</span><span class="p">,</span> <span class="s2">&quot;IsOk&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">brush</span><span class="o">.</span><span class="n">IsOk</span><span class="p">()):</span>
            <span class="n">black_tuple</span> <span class="o">=</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>
            <span class="n">brush</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">renderer</span><span class="o">.</span><span class="n">createBrush</span><span class="p">(</span><span class="n">black_tuple</span><span class="p">)</span>
        <span class="c1"># TODO: handle &lt;tspan&gt;, &lt;a&gt; and &lt;tref&gt;.</span>
        <span class="c1"># TODO: handle xml:space=&quot;preserve&quot;? The following more or less</span>
        <span class="c1"># corresponds to xml:space=&quot;default&quot;.</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">text</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="p">[]</span>
        <span class="n">text_anchor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text-anchor&quot;</span><span class="p">,</span> <span class="s2">&quot;start&quot;</span><span class="p">)</span>
        <span class="n">ops</span> <span class="o">=</span> <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">renderer</span><span class="o">.</span><span class="n">pushState</span><span class="p">,</span> <span class="p">())]</span>
        <span class="n">ops</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">createTransformOpsFromNode</span><span class="p">(</span><span class="n">node</span><span class="p">))</span>
        <span class="n">ops</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">renderer</span><span class="o">.</span><span class="n">setFont</span><span class="p">,</span> <span class="p">(</span><span class="n">font</span><span class="p">,</span> <span class="n">brush</span><span class="p">)),</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">renderer</span><span class="o">.</span><span class="n">DrawText</span><span class="p">,</span> <span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">brush</span><span class="p">,</span> <span class="n">text_anchor</span><span class="p">)),</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">renderer</span><span class="o">.</span><span class="n">popState</span><span class="p">,</span> <span class="p">()),</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">ops</span></div>

<div class="viewcode-block" id="SVGDocument.addRectToDocument"><a class="viewcode-back" href="../../../../api/enable.savage.svg.document.html#enable.savage.svg.document.SVGDocument.addRectToDocument">[docs]</a>    <span class="nd">@pathHandler</span>
    <span class="k">def</span> <span class="nf">addRectToDocument</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">attrAsFloat</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;width&quot;</span><span class="p">,</span> <span class="s2">&quot;height&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">rx</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;rx&quot;</span><span class="p">)</span>
        <span class="n">ry</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ry&quot;</span><span class="p">)</span>

        <span class="n">ops</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="s2">&quot;clip-path&quot;</span> <span class="ow">in</span> <span class="n">node</span><span class="p">:</span>
            <span class="n">element</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dereference</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;clip-path&quot;</span><span class="p">))</span>

            <span class="n">ops</span> <span class="o">=</span> <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">renderer</span><span class="o">.</span><span class="n">pushState</span><span class="p">,</span> <span class="p">())]</span>

            <span class="n">clip_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">renderer</span><span class="o">.</span><span class="n">makePath</span><span class="p">()</span>
            <span class="n">ops</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">createTransformOpsFromNode</span><span class="p">(</span><span class="n">element</span><span class="p">))</span>
            <span class="n">ops</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">generatePathOps</span><span class="p">(</span><span class="n">clip_path</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">element</span><span class="p">:</span>
                <span class="n">cpath</span><span class="p">,</span> <span class="n">cops</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">processElement</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">cpath</span><span class="p">:</span>
                    <span class="n">clip_path</span><span class="o">.</span><span class="n">AddPath</span><span class="p">(</span><span class="n">cpath</span><span class="p">)</span>
                    <span class="n">ops</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">renderer</span><span class="o">.</span><span class="n">clipPath</span><span class="p">,</span> <span class="p">(</span><span class="n">clip_path</span><span class="p">,)))</span>
                    <span class="n">path</span><span class="o">.</span><span class="n">AddPath</span><span class="p">(</span><span class="n">clip_path</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">cops</span><span class="p">:</span>
                    <span class="n">ops</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">cops</span><span class="p">)</span>
            <span class="n">ops</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">renderer</span><span class="o">.</span><span class="n">popState</span><span class="p">,</span> <span class="p">()))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">w</span> <span class="ow">and</span> <span class="n">h</span><span class="p">):</span>
            <span class="n">path</span><span class="o">.</span><span class="n">MoveToPoint</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>  <span class="c1"># keep the current point correct</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">rx</span> <span class="ow">or</span> <span class="n">ry</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">rx</span> <span class="ow">and</span> <span class="n">ry</span><span class="p">:</span>
                <span class="n">rx</span><span class="p">,</span> <span class="n">ry</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">rx</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">ry</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">rx</span><span class="p">:</span>
                <span class="n">rx</span> <span class="o">=</span> <span class="n">ry</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">rx</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">ry</span><span class="p">:</span>
                <span class="n">rx</span> <span class="o">=</span> <span class="n">ry</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ry</span><span class="p">)</span>
            <span class="c1"># value clamping as per spec section 9.2</span>
            <span class="n">rx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">rx</span><span class="p">,</span> <span class="n">w</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">ry</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">ry</span><span class="p">,</span> <span class="n">h</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>

            <span class="n">path</span><span class="o">.</span><span class="n">AddRoundedRectangleEx</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">rx</span><span class="p">,</span> <span class="n">ry</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clippingStack</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">renderer</span><span class="o">.</span><span class="n">clipPath</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">path</span><span class="o">.</span><span class="n">AddRectangle</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">path</span><span class="p">,</span> <span class="n">ops</span></div>

<div class="viewcode-block" id="SVGDocument.addCircleToDocument"><a class="viewcode-back" href="../../../../api/enable.savage.svg.document.html#enable.savage.svg.document.SVGDocument.addCircleToDocument">[docs]</a>    <span class="nd">@pathHandler</span>
    <span class="k">def</span> <span class="nf">addCircleToDocument</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="p">[</span><span class="n">attrAsFloat</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;cx&quot;</span><span class="p">,</span> <span class="s2">&quot;cy&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)]</span>
        <span class="n">path</span><span class="o">.</span><span class="n">AddCircle</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span></div>

<div class="viewcode-block" id="SVGDocument.addEllipseToDocument"><a class="viewcode-back" href="../../../../api/enable.savage.svg.document.html#enable.savage.svg.document.SVGDocument.addEllipseToDocument">[docs]</a>    <span class="nd">@pathHandler</span>
    <span class="k">def</span> <span class="nf">addEllipseToDocument</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">,</span> <span class="n">rx</span><span class="p">,</span> <span class="n">ry</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nb">float</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;cx&quot;</span><span class="p">,</span> <span class="s2">&quot;cy&quot;</span><span class="p">,</span> <span class="s2">&quot;rx&quot;</span><span class="p">,</span> <span class="s2">&quot;ry&quot;</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="c1"># cx, cy are centerpoint.</span>
        <span class="c1"># rx, ry are radius.</span>
        <span class="k">if</span> <span class="n">rx</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">ry</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">path</span><span class="o">.</span><span class="n">AddEllipse</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">,</span> <span class="n">rx</span><span class="p">,</span> <span class="n">ry</span><span class="p">)</span></div>

<div class="viewcode-block" id="SVGDocument.addLineToDocument"><a class="viewcode-back" href="../../../../api/enable.savage.svg.document.html#enable.savage.svg.document.SVGDocument.addLineToDocument">[docs]</a>    <span class="nd">@pathHandler</span>
    <span class="k">def</span> <span class="nf">addLineToDocument</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">attrAsFloat</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;x1&quot;</span><span class="p">,</span> <span class="s2">&quot;y1&quot;</span><span class="p">,</span> <span class="s2">&quot;x2&quot;</span><span class="p">,</span> <span class="s2">&quot;y2&quot;</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="n">path</span><span class="o">.</span><span class="n">MoveToPoint</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">)</span>
        <span class="n">path</span><span class="o">.</span><span class="n">AddLineToPoint</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">)</span></div>

<div class="viewcode-block" id="SVGDocument.addPolyLineToDocument"><a class="viewcode-back" href="../../../../api/enable.savage.svg.document.html#enable.savage.svg.document.SVGDocument.addPolyLineToDocument">[docs]</a>    <span class="nd">@pathHandler</span>
    <span class="k">def</span> <span class="nf">addPolyLineToDocument</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="c1"># translate to pathdata and render that</span>
        <span class="n">data</span> <span class="o">=</span> <span class="s2">&quot;M &quot;</span> <span class="o">+</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;points&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addPathDataToPath</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span></div>

<div class="viewcode-block" id="SVGDocument.addPolygonToDocument"><a class="viewcode-back" href="../../../../api/enable.savage.svg.document.html#enable.savage.svg.document.SVGDocument.addPolygonToDocument">[docs]</a>    <span class="nd">@pathHandler</span>
    <span class="k">def</span> <span class="nf">addPolygonToDocument</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="c1"># translate to pathdata and render that</span>
        <span class="n">points</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;points&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">points</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="s2">&quot;M &quot;</span> <span class="o">+</span> <span class="n">points</span> <span class="o">+</span> <span class="s2">&quot; Z&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">addPathDataToPath</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span></div>

<div class="viewcode-block" id="SVGDocument.addPathDataToDocument"><a class="viewcode-back" href="../../../../api/enable.savage.svg.document.html#enable.savage.svg.document.SVGDocument.addPathDataToDocument">[docs]</a>    <span class="nd">@pathHandler</span>
    <span class="k">def</span> <span class="nf">addPathDataToDocument</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addPathDataToPath</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;d&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span> <span class="n">path</span><span class="p">)</span></div>

<div class="viewcode-block" id="SVGDocument.addPathDataToPath"><a class="viewcode-back" href="../../../../api/enable.savage.svg.document.html#enable.savage.svg.document.SVGDocument.addPathDataToPath">[docs]</a>    <span class="k">def</span> <span class="nf">addPathDataToPath</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lastControl</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lastControlQ</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">firstPoints</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">def</span> <span class="nf">normalizeStrokes</span><span class="p">(</span><span class="n">parseResults</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot; The data comes from the parser in the</span>
<span class="sd">            form of (command, [list of arguments]).</span>
<span class="sd">            We translate that to [(command, args[0]), (command, args[1])]</span>
<span class="sd">            via a generator.</span>

<span class="sd">            M is special cased because its subsequent arguments</span>
<span class="sd">            become linetos.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">for</span> <span class="n">command</span><span class="p">,</span> <span class="n">arguments</span> <span class="ow">in</span> <span class="n">parseResults</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">arguments</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="p">())</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">arguments</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">arguments</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">command</span> <span class="o">==</span> <span class="s2">&quot;m&quot;</span><span class="p">:</span>
                        <span class="k">yield</span> <span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="nb">next</span><span class="p">(</span><span class="n">arguments</span><span class="p">))</span>
                        <span class="n">command</span> <span class="o">=</span> <span class="s2">&quot;l&quot;</span>
                    <span class="k">elif</span> <span class="n">command</span> <span class="o">==</span> <span class="s2">&quot;M&quot;</span><span class="p">:</span>
                        <span class="k">yield</span> <span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="nb">next</span><span class="p">(</span><span class="n">arguments</span><span class="p">))</span>
                        <span class="n">command</span> <span class="o">=</span> <span class="s2">&quot;L&quot;</span>
                    <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">arguments</span><span class="p">:</span>
                        <span class="k">yield</span> <span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">parsed</span> <span class="o">=</span> <span class="n">svg_parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">SyntaxError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;SyntaxError: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;data = </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">data</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">stroke</span> <span class="ow">in</span> <span class="n">normalizeStrokes</span><span class="p">(</span><span class="n">parsed</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">addStrokeToPath</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">stroke</span><span class="p">)</span></div>

<div class="viewcode-block" id="SVGDocument.generatePathOps"><a class="viewcode-back" href="../../../../api/enable.savage.svg.document.html#enable.savage.svg.document.SVGDocument.generatePathOps">[docs]</a>    <span class="k">def</span> <span class="nf">generatePathOps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Look at the current state and generate the</span>
<span class="sd">        draw operations (fill, stroke, neither) for the path.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ops</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">brush</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getBrushFromState</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">fillRule</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fill-rule&quot;</span><span class="p">,</span> <span class="s2">&quot;nonzero&quot;</span><span class="p">)</span>
        <span class="n">fr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">renderer</span><span class="o">.</span><span class="n">fill_rules</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">fillRule</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">brush</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">brush</span><span class="p">,</span> <span class="n">AbstractGradientBrush</span><span class="p">):</span>
                <span class="n">ops</span><span class="o">.</span><span class="n">extend</span><span class="p">([(</span><span class="bp">self</span><span class="o">.</span><span class="n">renderer</span><span class="o">.</span><span class="n">gradientPath</span><span class="p">,</span> <span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">brush</span><span class="p">))])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ops</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">renderer</span><span class="o">.</span><span class="n">setBrush</span><span class="p">,</span> <span class="p">(</span><span class="n">brush</span><span class="p">,)),</span>
                        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">renderer</span><span class="o">.</span><span class="n">fillPath</span><span class="p">,</span> <span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">fr</span><span class="p">)),</span>
                    <span class="p">]</span>
                <span class="p">)</span>
        <span class="n">pen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getPenFromState</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">pen</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ops</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">renderer</span><span class="o">.</span><span class="n">setPen</span><span class="p">,</span> <span class="p">(</span><span class="n">pen</span><span class="p">,)),</span>
                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">renderer</span><span class="o">.</span><span class="n">strokePath</span><span class="p">,</span> <span class="p">(</span><span class="n">path</span><span class="p">,)),</span>
                <span class="p">]</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">ops</span></div>

<div class="viewcode-block" id="SVGDocument.getPenFromState"><a class="viewcode-back" href="../../../../api/enable.savage.svg.document.html#enable.savage.svg.document.SVGDocument.getPenFromState">[docs]</a>    <span class="k">def</span> <span class="nf">getPenFromState</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">pencolour</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;stroke&quot;</span><span class="p">,</span> <span class="s2">&quot;none&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pencolour</span> <span class="o">==</span> <span class="s2">&quot;currentColor&quot;</span><span class="p">:</span>
            <span class="n">pencolour</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;color&quot;</span><span class="p">,</span> <span class="s2">&quot;none&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pencolour</span> <span class="o">==</span> <span class="s2">&quot;transparent&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">renderer</span><span class="o">.</span><span class="n">TransparentPen</span>
        <span class="k">if</span> <span class="n">pencolour</span> <span class="o">==</span> <span class="s2">&quot;none&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">renderer</span><span class="o">.</span><span class="n">NullPen</span>
        <span class="nb">type</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">colourValue</span><span class="o">.</span><span class="n">parseString</span><span class="p">(</span><span class="n">pencolour</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s2">&quot;URL&quot;</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Color servers for stroking not implemented&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">renderer</span><span class="o">.</span><span class="n">NullPen</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">value</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">renderer</span><span class="o">.</span><span class="n">NullPen</span>
            <span class="n">pen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">renderer</span><span class="o">.</span><span class="n">createPen</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;stroke-width&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">width</span><span class="p">:</span>
            <span class="n">width</span><span class="p">,</span> <span class="n">units</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">length</span><span class="o">.</span><span class="n">parseString</span><span class="p">(</span><span class="n">width</span><span class="p">)</span>
            <span class="n">pen</span><span class="o">.</span><span class="n">SetWidth</span><span class="p">(</span><span class="n">width</span><span class="p">)</span>
        <span class="n">stroke_dasharray</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;stroke-dasharray&quot;</span><span class="p">,</span> <span class="s2">&quot;none&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">stroke_dasharray</span> <span class="o">!=</span> <span class="s2">&quot;none&quot;</span><span class="p">:</span>
            <span class="n">stroke_dasharray</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                <span class="nb">map</span><span class="p">(</span><span class="n">valueToPixels</span><span class="p">,</span> <span class="n">stroke_dasharray</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">stroke_dasharray</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span><span class="p">:</span>
                <span class="c1"># Repeat to get an even array.</span>
                <span class="n">stroke_dasharray</span> <span class="o">=</span> <span class="n">stroke_dasharray</span> <span class="o">*</span> <span class="mi">2</span>
            <span class="n">stroke_dashoffset</span> <span class="o">=</span> <span class="n">valueToPixels</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;stroke-dashoffset&quot;</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">renderer</span><span class="o">.</span><span class="n">setPenDash</span><span class="p">(</span><span class="n">pen</span><span class="p">,</span> <span class="n">stroke_dasharray</span><span class="p">,</span> <span class="n">stroke_dashoffset</span><span class="p">)</span>
        <span class="n">pen</span><span class="o">.</span><span class="n">SetCap</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">renderer</span><span class="o">.</span><span class="n">caps</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;stroke-linecap&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">renderer</span><span class="o">.</span><span class="n">caps</span><span class="p">[</span><span class="s2">&quot;butt&quot;</span><span class="p">],</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">pen</span><span class="o">.</span><span class="n">SetJoin</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">renderer</span><span class="o">.</span><span class="n">joins</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;stroke-linejoin&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">renderer</span><span class="o">.</span><span class="n">joins</span><span class="p">[</span><span class="s2">&quot;miter&quot;</span><span class="p">],</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">renderer</span><span class="o">.</span><span class="n">createNativePen</span><span class="p">(</span><span class="n">pen</span><span class="p">)</span></div>

<div class="viewcode-block" id="SVGDocument.parseStops"><a class="viewcode-back" href="../../../../api/enable.savage.svg.document.html#enable.savage.svg.document.SVGDocument.parseStops">[docs]</a>    <span class="k">def</span> <span class="nf">parseStops</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Parse the color stops from a gradient definition.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">stops</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">gradient_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getLocalState</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">stop</span> <span class="ow">in</span> <span class="n">element</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">stop</span><span class="o">.</span><span class="n">tag</span> <span class="o">!=</span> <span class="n">SVG</span><span class="o">.</span><span class="n">stop</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="s2">&quot;Skipping non-&lt;stop&gt; element &lt;</span><span class="si">%s</span><span class="s2">&gt; in &lt;</span><span class="si">%s</span><span class="s2">&gt;&quot;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="n">stop</span><span class="o">.</span><span class="n">tag</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">tag</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">stopstate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getLocalState</span><span class="p">(</span><span class="n">stop</span><span class="p">,</span> <span class="n">gradient_state</span><span class="p">)</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="n">fractionalValue</span><span class="p">(</span><span class="n">stop</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;offset&quot;</span><span class="p">))</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">)</span>
            <span class="n">default_opacity</span> <span class="o">=</span> <span class="s2">&quot;1&quot;</span>
            <span class="n">color</span> <span class="o">=</span> <span class="n">stopstate</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;stop-color&quot;</span><span class="p">,</span> <span class="s2">&quot;black&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">color</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;inherit&quot;</span><span class="p">,</span> <span class="s2">&quot;currentColor&quot;</span><span class="p">]:</span>
                <span class="c1"># Try looking up in the gradient element itself.</span>
                <span class="c1"># FIXME: Look farther up?</span>
                <span class="n">color</span> <span class="o">=</span> <span class="n">stopstate</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;color&quot;</span><span class="p">,</span> <span class="s2">&quot;black&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">color</span> <span class="o">==</span> <span class="s2">&quot;none&quot;</span><span class="p">:</span>
                <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;black&quot;</span>
                <span class="n">default_opacity</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span>
            <span class="nb">type</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="n">colourValue</span><span class="o">.</span><span class="n">parseString</span><span class="p">(</span><span class="n">color</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s2">&quot;URL&quot;</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Color servers for gradients not implemented&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">color</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="c1"># FIXME: is this right?</span>
                <span class="n">color</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
            <span class="n">opacity</span> <span class="o">=</span> <span class="n">stopstate</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;stop-opacity&quot;</span><span class="p">,</span> <span class="n">default_opacity</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">opacity</span> <span class="o">==</span> <span class="s2">&quot;inherit&quot;</span><span class="p">:</span>
                <span class="c1"># FIXME: what value to inherit?</span>
                <span class="n">opacity</span> <span class="o">=</span> <span class="s2">&quot;1&quot;</span>
            <span class="n">opacity</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">opacity</span><span class="p">)</span>
            <span class="n">row</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">offset</span><span class="p">,</span>
                <span class="n">color</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mf">255.0</span><span class="p">,</span>
                <span class="n">color</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mf">255.0</span><span class="p">,</span>
                <span class="n">color</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="mf">255.0</span><span class="p">,</span>
                <span class="n">opacity</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">stops</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
        <span class="n">stops</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">stops</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="k">if</span> <span class="n">stops</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">stops</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,)</span> <span class="o">+</span> <span class="n">stops</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">:])</span>
        <span class="k">if</span> <span class="n">stops</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="n">stops</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="mf">1.0</span><span class="p">,)</span> <span class="o">+</span> <span class="n">stops</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">:])</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">stops</span><span class="p">)</span></div>

<div class="viewcode-block" id="SVGDocument.getBrushFromState"><a class="viewcode-back" href="../../../../api/enable.savage.svg.document.html#enable.savage.svg.document.SVGDocument.getBrushFromState">[docs]</a>    <span class="k">def</span> <span class="nf">getBrushFromState</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">brushcolour</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span> <span class="s2">&quot;black&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="nb">type</span><span class="p">,</span> <span class="n">details</span> <span class="o">=</span> <span class="n">paintValue</span><span class="o">.</span><span class="n">parseString</span><span class="p">(</span><span class="n">brushcolour</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s2">&quot;URL&quot;</span><span class="p">:</span>
            <span class="n">url</span><span class="p">,</span> <span class="n">fallback</span> <span class="o">=</span> <span class="n">details</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">urlparse</span><span class="o">.</span><span class="n">urlunsplit</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">element</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dereference</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">ParseError</span><span class="p">:</span>
                <span class="n">element</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">element</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">fallback</span><span class="p">:</span>
                    <span class="nb">type</span><span class="p">,</span> <span class="n">details</span> <span class="o">=</span> <span class="n">fallback</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># The referencing tag controls the kind of gradient. Mostly,</span>
                <span class="c1"># it&#39;s just the stops that are pulled from the referenced</span>
                <span class="c1"># gradient tag.</span>
                <span class="n">element_tag</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">tag</span>
                <span class="k">if</span> <span class="n">element_tag</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">SVG</span><span class="o">.</span><span class="n">linearGradient</span><span class="p">,</span> <span class="n">SVG</span><span class="o">.</span><span class="n">radialGradient</span><span class="p">):</span>
                    <span class="k">if</span> <span class="s2">&quot;}&quot;</span> <span class="ow">in</span> <span class="n">element_tag</span><span class="p">:</span>
                        <span class="n">element_tag</span><span class="p">[</span><span class="n">element_tag</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;}&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;&lt;</span><span class="si">%s</span><span class="s2">&gt; not implemented&quot;</span> <span class="o">%</span> <span class="n">element_tag</span><span class="p">)</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">renderer</span><span class="o">.</span><span class="n">NullBrush</span>
                <span class="n">href</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">XLink</span><span class="o">.</span><span class="n">href</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">element</span><span class="p">])</span>
                <span class="c1"># The attributes on the referencing element override those on</span>
                <span class="c1"># the referenced element.</span>
                <span class="n">state</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
                <span class="k">while</span> <span class="n">href</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># Gradient is a reference.</span>
                    <span class="n">element</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dereference</span><span class="p">(</span><span class="n">href</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
                        <span class="c1"># FIXME: if they are loaded from another file, will</span>
                        <span class="c1"># element identity work correctly?</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                            <span class="s2">&quot;Element referred to by </span><span class="si">%r</span><span class="s2"> is a &quot;</span>
                            <span class="s2">&quot;circular reference.&quot;</span> <span class="o">%</span> <span class="n">href</span>
                        <span class="p">)</span>
                    <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
                    <span class="c1"># new_state = dict(element.items())</span>
                    <span class="c1"># new_state.update(state)</span>
                    <span class="c1"># state = new_state</span>
                    <span class="n">href</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">XLink</span><span class="o">.</span><span class="n">href</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">spreadMethod</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;spreadMethod&quot;</span><span class="p">,</span> <span class="s2">&quot;pad&quot;</span><span class="p">)</span>
                <span class="n">transforms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">createTransformOpsFromNode</span><span class="p">(</span>
                    <span class="n">state</span><span class="p">,</span> <span class="s2">&quot;gradientTransform&quot;</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">transforms</span><span class="p">:</span>
                    <span class="n">transforms</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">units</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;gradientUnits&quot;</span><span class="p">,</span> <span class="s2">&quot;objectBoundingBox&quot;</span><span class="p">)</span>
                <span class="n">stops</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parseStops</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">stops</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">renderer</span><span class="o">.</span><span class="n">NullBrush</span>
                <span class="k">if</span> <span class="n">element_tag</span> <span class="o">==</span> <span class="n">SVG</span><span class="o">.</span><span class="n">linearGradient</span><span class="p">:</span>
                    <span class="n">x1</span> <span class="o">=</span> <span class="n">attrAsFloat</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="s2">&quot;x1&quot;</span><span class="p">,</span> <span class="s2">&quot;0%&quot;</span><span class="p">)</span>
                    <span class="n">y1</span> <span class="o">=</span> <span class="n">attrAsFloat</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="s2">&quot;y1&quot;</span><span class="p">,</span> <span class="s2">&quot;0%&quot;</span><span class="p">)</span>
                    <span class="n">x2</span> <span class="o">=</span> <span class="n">attrAsFloat</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="s2">&quot;x2&quot;</span><span class="p">,</span> <span class="s2">&quot;100%&quot;</span><span class="p">)</span>
                    <span class="n">y2</span> <span class="o">=</span> <span class="n">attrAsFloat</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="s2">&quot;y2&quot;</span><span class="p">,</span> <span class="s2">&quot;0%&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">renderer</span><span class="o">.</span><span class="n">createLinearGradientBrush</span><span class="p">(</span>
                        <span class="n">x1</span><span class="p">,</span>
                        <span class="n">y1</span><span class="p">,</span>
                        <span class="n">x2</span><span class="p">,</span>
                        <span class="n">y2</span><span class="p">,</span>
                        <span class="n">stops</span><span class="p">,</span>
                        <span class="n">spreadMethod</span><span class="o">=</span><span class="n">spreadMethod</span><span class="p">,</span>
                        <span class="n">transforms</span><span class="o">=</span><span class="n">transforms</span><span class="p">,</span>
                        <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">elif</span> <span class="n">element_tag</span> <span class="o">==</span> <span class="n">SVG</span><span class="o">.</span><span class="n">radialGradient</span><span class="p">:</span>
                    <span class="n">cx</span> <span class="o">=</span> <span class="n">attrAsFloat</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="s2">&quot;cx&quot;</span><span class="p">,</span> <span class="s2">&quot;50%&quot;</span><span class="p">)</span>
                    <span class="n">cy</span> <span class="o">=</span> <span class="n">attrAsFloat</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="s2">&quot;cy&quot;</span><span class="p">,</span> <span class="s2">&quot;50%&quot;</span><span class="p">)</span>
                    <span class="n">r</span> <span class="o">=</span> <span class="n">attrAsFloat</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="s2">&quot;50%&quot;</span><span class="p">)</span>
                    <span class="n">fx</span> <span class="o">=</span> <span class="n">attrAsFloat</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="s2">&quot;fx&quot;</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cx&quot;</span><span class="p">,</span> <span class="s2">&quot;50%&quot;</span><span class="p">))</span>
                    <span class="n">fy</span> <span class="o">=</span> <span class="n">attrAsFloat</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="s2">&quot;fy&quot;</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cy&quot;</span><span class="p">,</span> <span class="s2">&quot;50%&quot;</span><span class="p">))</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">renderer</span><span class="o">.</span><span class="n">createRadialGradientBrush</span><span class="p">(</span>
                        <span class="n">cx</span><span class="p">,</span>
                        <span class="n">cy</span><span class="p">,</span>
                        <span class="n">r</span><span class="p">,</span>
                        <span class="n">stops</span><span class="p">,</span>
                        <span class="n">fx</span><span class="p">,</span>
                        <span class="n">fy</span><span class="p">,</span>
                        <span class="n">spreadMethod</span><span class="o">=</span><span class="n">spreadMethod</span><span class="p">,</span>
                        <span class="n">transforms</span><span class="o">=</span><span class="n">transforms</span><span class="p">,</span>
                        <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># invlid gradient specified</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">renderer</span><span class="o">.</span><span class="n">NullBrush</span>
            <span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s2">&quot;CURRENTCOLOR&quot;</span><span class="p">:</span>
            <span class="nb">type</span><span class="p">,</span> <span class="n">details</span> <span class="o">=</span> <span class="n">paintValue</span><span class="o">.</span><span class="n">parseString</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;color&quot;</span><span class="p">,</span> <span class="s2">&quot;none&quot;</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s2">&quot;RGB&quot;</span><span class="p">:</span>
            <span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">details</span>
        <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s2">&quot;NONE&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">renderer</span><span class="o">.</span><span class="n">NullBrush</span>
        <span class="n">opacity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;fill-opacity&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;opacity&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">opacity</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">opacity</span><span class="p">)</span>
        <span class="n">opacity</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">opacity</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="mi">255</span> <span class="o">*</span> <span class="n">opacity</span>
        <span class="c1"># using try/except block instead of</span>
        <span class="c1"># just setdefault because the brush and colour would</span>
        <span class="c1"># be created every time anyway in order to pass them,</span>
        <span class="c1"># defeating the purpose of the cache</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">brush</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">brushCache</span><span class="p">[(</span><span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">)]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">brush</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">brushCache</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span>
                <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">renderer</span><span class="o">.</span><span class="n">createBrush</span><span class="p">((</span><span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">))</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">brush</span></div>

<div class="viewcode-block" id="SVGDocument.addStrokeToPath"><a class="viewcode-back" href="../../../../api/enable.savage.svg.document.html#enable.savage.svg.document.SVGDocument.addStrokeToPath">[docs]</a>    <span class="k">def</span> <span class="nf">addStrokeToPath</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">stroke</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Given a stroke from a path command</span>
<span class="sd">        (in the form (command, arguments)) create the path</span>
<span class="sd">        commands that represent it.</span>

<span class="sd">        TODO: break out into (yet another) class/module,</span>
<span class="sd">        especially so we can get O(1) dispatch on type?</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">type</span><span class="p">,</span> <span class="n">arg</span> <span class="o">=</span> <span class="n">stroke</span>
        <span class="n">relative</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="nb">type</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="n">relative</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">ox</span><span class="p">,</span> <span class="n">oy</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">GetCurrentPoint</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ox</span> <span class="o">=</span> <span class="n">oy</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">def</span> <span class="nf">normalizePoint</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">arg</span>
            <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">ox</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">oy</span>

        <span class="k">def</span> <span class="nf">reflectPoint</span><span class="p">(</span><span class="n">point</span><span class="p">,</span> <span class="n">relativeTo</span><span class="p">):</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">point</span>
            <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">relativeTo</span>
            <span class="k">return</span> <span class="p">((</span><span class="n">a</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">x</span><span class="p">),</span> <span class="p">((</span><span class="n">b</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">y</span><span class="p">)</span>

        <span class="nb">type</span> <span class="o">=</span> <span class="nb">type</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s2">&quot;M&quot;</span><span class="p">:</span>
            <span class="n">pt</span> <span class="o">=</span> <span class="n">normalizePoint</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">firstPoints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pt</span><span class="p">)</span>
            <span class="n">path</span><span class="o">.</span><span class="n">MoveToPoint</span><span class="p">(</span><span class="o">*</span><span class="n">pt</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s2">&quot;L&quot;</span><span class="p">:</span>
            <span class="n">pt</span> <span class="o">=</span> <span class="n">normalizePoint</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
            <span class="n">path</span><span class="o">.</span><span class="n">AddLineToPoint</span><span class="p">(</span><span class="o">*</span><span class="n">pt</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s2">&quot;C&quot;</span><span class="p">:</span>
            <span class="n">control1</span><span class="p">,</span> <span class="n">control2</span><span class="p">,</span> <span class="n">endpoint</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">normalizePoint</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lastControl</span> <span class="o">=</span> <span class="n">control2</span>
            <span class="n">path</span><span class="o">.</span><span class="n">AddCurveToPoint</span><span class="p">(</span><span class="n">control1</span><span class="p">,</span> <span class="n">control2</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s2">&quot;S&quot;</span><span class="p">:</span>
            <span class="n">control2</span><span class="p">,</span> <span class="n">endpoint</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">normalizePoint</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lastControl</span><span class="p">:</span>
                <span class="n">control1</span> <span class="o">=</span> <span class="n">reflectPoint</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">lastControl</span><span class="p">,</span> <span class="n">path</span><span class="o">.</span><span class="n">GetCurrentPoint</span><span class="p">()</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">control1</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">GetCurrentPoint</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lastControl</span> <span class="o">=</span> <span class="n">control2</span>
            <span class="n">path</span><span class="o">.</span><span class="n">AddCurveToPoint</span><span class="p">(</span><span class="n">control1</span><span class="p">,</span> <span class="n">control2</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s2">&quot;Q&quot;</span><span class="p">:</span>
            <span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">),</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">normalizePoint</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lastControlQ</span> <span class="o">=</span> <span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">)</span>
            <span class="n">path</span><span class="o">.</span><span class="n">AddQuadCurveToPoint</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s2">&quot;T&quot;</span><span class="p">:</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="o">=</span> <span class="n">normalizePoint</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lastControlQ</span><span class="p">:</span>
                <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span> <span class="o">=</span> <span class="n">reflectPoint</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">lastControlQ</span><span class="p">,</span> <span class="n">path</span><span class="o">.</span><span class="n">GetCurrentPoint</span><span class="p">()</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">GetCurrentPoint</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lastControlQ</span> <span class="o">=</span> <span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">)</span>
            <span class="n">path</span><span class="o">.</span><span class="n">AddQuadCurveToPoint</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s2">&quot;V&quot;</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">normalizePoint</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="n">arg</span><span class="p">))</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">GetCurrentPoint</span><span class="p">()</span>
            <span class="n">path</span><span class="o">.</span><span class="n">AddLineToPoint</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s2">&quot;H&quot;</span><span class="p">:</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">normalizePoint</span><span class="p">((</span><span class="n">arg</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">GetCurrentPoint</span><span class="p">()</span>
            <span class="n">path</span><span class="o">.</span><span class="n">AddLineToPoint</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s2">&quot;A&quot;</span><span class="p">:</span>
            <span class="p">(</span>
                <span class="p">(</span><span class="n">rx</span><span class="p">,</span> <span class="n">ry</span><span class="p">),</span>  <span class="c1"># radii of ellipse</span>
                <span class="n">angle</span><span class="p">,</span>  <span class="c1"># angle of rotation on the ellipse in degrees</span>
                <span class="n">large_arc_flag</span><span class="p">,</span>
                <span class="n">sweep_flag</span><span class="p">,</span>  <span class="c1"># arc and stroke angle flags</span>
                <span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">),</span>  <span class="c1"># endpoint on the arc</span>
            <span class="p">)</span> <span class="o">=</span> <span class="n">arg</span>

            <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">normalizePoint</span><span class="p">((</span><span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">))</span>

            <span class="n">path</span><span class="o">.</span><span class="n">elliptical_arc_to</span><span class="p">(</span>
                <span class="n">rx</span><span class="p">,</span> <span class="n">ry</span><span class="p">,</span> <span class="n">angle</span><span class="p">,</span> <span class="n">large_arc_flag</span><span class="p">,</span> <span class="n">sweep_flag</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s2">&quot;Z&quot;</span><span class="p">:</span>
            <span class="c1"># ~ Bugginess:</span>
            <span class="c1"># ~ CloseSubpath() doesn&#39;t change the</span>
            <span class="c1"># ~ current point, as SVG spec requires.</span>
            <span class="c1"># ~ However, manually moving to the endpoint afterward opens a new</span>
            <span class="c1"># ~ subpath and (apparently) messes with stroked but not filled</span>
            <span class="c1"># ~ paths.</span>
            <span class="c1"># ~ This is possibly a bug in GDI+?</span>
            <span class="c1"># ~ Manually closing the path via AddLineTo gives incorrect line</span>
            <span class="c1"># ~ join results</span>
            <span class="c1"># ~ Manually closing the path *and* calling CloseSubpath() appears</span>
            <span class="c1"># ~ to give correct results on win32</span>

            <span class="n">path</span><span class="o">.</span><span class="n">CloseSubpath</span><span class="p">()</span></div>

<div class="viewcode-block" id="SVGDocument.render"><a class="viewcode-back" href="../../../../api/enable.savage.svg.document.html#enable.savage.svg.document.SVGDocument.render">[docs]</a>    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;ops&quot;</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="k">for</span> <span class="n">op</span><span class="p">,</span> <span class="n">args</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ops</span><span class="p">:</span>
            <span class="n">op</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span></div></div>

</pre></div>

          </div>
        </div>
          </div>
      <div class="spc-rightsidebar span3">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../../index.html">
              <img class="logo" src="../../../../_static/img/e-logo.png" alt="Logo">
            </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
        </div>
      </div>
    </div>

    <div class="container container-navbar-bottom">
      <div class="spc-navbar">
        
      </div>
    </div>
    <div class="container">
    <div class="footer">
    <div class="row-fluid">
    <ul class="inline pull-left">
      <li>
        &copy; Copyright 2005-2021, Enthought
      </li>
      <li>
      Last updated on Jun 15, 2021.
      </li>
      <li>
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 2.3.1.
      </li>
    </ul>
    </div>
    </div>
    </div>
  </body>
</html>