<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8">
    
    <title>Kiva Font Management &mdash; enable 5.3.0 documentation</title>
    
    <link rel="stylesheet" type="text/css" href="../_static/css/spc-bootstrap.css">
    <link rel="stylesheet" type="text/css" href="../_static/css/spc-extend.css">
    <link rel="stylesheet" href="../_static/enthought.css" type="text/css" >
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" >
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '5.3.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        LINK_SUFFIX: '.html',
        SOURCELINK_SUFFIX: '.txt',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/js/copybutton.js"></script>
    <script type="text/javascript" src="../_static/js/wrap_on_dot.js"></script>
    <link rel="shortcut icon" href="../_static/img/favicon.png">
    <link rel="index" title="Index" href="../genindex.html" >
    <link rel="search" title="Search" href="../search.html" >
    <link rel="top" title="enable 5.3.0 documentation" href="../index.html" >
    <link rel="next" title="Writing A Kiva Backend" href="writing_a_backend.html" >
    <link rel="prev" title="kiva.trait_defs.ui.wx.kiva_font_editor module" href="../api/kiva.trait_defs.ui.wx.kiva_font_editor.html" > 
  </head>
  <body>
  <div class="container">
    <div class="header">
    </div>
  </div>

    <div class="container">
      <div class="main">
        
	<div class="row-fluid">
	  <div class="span12">
	    <div class="spc-navbar">
              
    <ul class="nav nav-pills pull-left">
	
        <li class="active"><a href="../index.html">enable 5.3.0 documentation</a></li>
	 
    </ul>
              
              
    <ul class="nav nav-pills pull-right">
      <li class="active">
        <a href="../genindex.html" title="General Index"
           accesskey="I">index</a>
      </li>
      <li class="active">
        <a href="../py-modindex.html" title="Python Module Index"
           >modules</a>
      </li>
      <li class="active">
        <a href="writing_a_backend.html" title="Writing A Kiva Backend"
           accesskey="N">next</a>
      </li>
      <li class="active">
        <a href="../api/kiva.trait_defs.ui.wx.kiva_font_editor.html" title="kiva.trait_defs.ui.wx.kiva_font_editor module"
           accesskey="P">previous</a>
      </li>
    </ul>
              
	    </div>
	  </div>
	</div>
        

	<div class="row-fluid">
          <div class="span9">
            
        <div class="bodywrapper">
          <div class="body" id="spc-section-body" role="main">
            
  <div class="section" id="kiva-font-management">
<span id="id1"></span><h1>Kiva Font Management<a class="headerlink" href="#kiva-font-management" title="Permalink to this headline">¶</a></h1>
<p>Kiva’s <code class="xref py py-class docutils literal notranslate"><span class="pre">FontManager</span></code> code originated in the Matplotlib code base. Until
version 5.1.0 it was largely unchanged. From 5.1.0 forward, it has been
refactored to emphasize that it’s an internal detail which should be avoided by
3rd party code.</p>
<p>This document aims to describe the structure of the code circa version 5.1.0.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Some Kiva backends don’t use the <code class="xref py py-class docutils literal notranslate"><span class="pre">FontManager</span></code> to resolve fonts
but instead use internal methods. For example the QPainter backend uses
Qt’s font management system to resolve font definitons.</p>
</div>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>The basic function of <code class="xref py py-class docutils literal notranslate"><span class="pre">FontManager</span></code> is to provide a <code class="xref py py-meth docutils literal notranslate"><span class="pre">findfont()</span></code>
method which can be called by the <a class="reference internal" href="../api/kiva.fonttools.font.html#kiva.fonttools.font.Font" title="kiva.fonttools.font.Font"><code class="xref py py-class docutils literal notranslate"><span class="pre">Font</span></code></a>
class to resolve a font name or font file location on the system where the code
is running.</p>
<p>To accomplish this, it:</p>
<ol class="arabic simple">
<li><p>Scans the file system for files with known font file extensions (<code class="docutils literal notranslate"><span class="pre">.ttf</span></code>,
<code class="docutils literal notranslate"><span class="pre">.ttc</span></code>, <code class="docutils literal notranslate"><span class="pre">.otf</span></code>, <code class="docutils literal notranslate"><span class="pre">.afm</span></code>) [<code class="xref py py-func docutils literal notranslate"><span class="pre">scan_system_fonts()</span></code>]</p></li>
<li><p>Examines all the font files identified in the first step and extracts their
metadata using <a class="reference external" href="https://fonttools.readthedocs.io/en/latest/">fonttools</a>.
[<code class="xref py py-func docutils literal notranslate"><span class="pre">create_font_database()</span></code>]</p></li>
<li><p>The <code class="xref py py-class docutils literal notranslate"><span class="pre">FontManager</span></code> is then ready to be used.
<a class="reference internal" href="../api/kiva.fonttools.font.html#kiva.fonttools.font.Font" title="kiva.fonttools.font.Font"><code class="xref py py-class docutils literal notranslate"><span class="pre">Font</span></code></a> instances call <code class="xref py py-meth docutils literal notranslate"><span class="pre">findfont()</span></code>
on the global <code class="xref py py-class docutils literal notranslate"><span class="pre">FontManager</span></code> singleton as needed.</p></li>
</ol>
<p>Because scanning a system for available fonts is quite an expensive operation,
<code class="xref py py-class docutils literal notranslate"><span class="pre">FontManager</span></code> stores a
<a class="reference external" href="https://docs.python.org/3/library/pickle.html">pickled</a> copy of its global
singleton in a cache file. And because <code class="docutils literal notranslate"><span class="pre">pickle</span></code> is notoriously brittle, the
font manager has a <code class="xref py py-attr docutils literal notranslate"><span class="pre">__version__</span></code> attribute must be incremented any
time the attributes or their classes (<code class="xref py py-class docutils literal notranslate"><span class="pre">FontEntry</span></code>, <code class="xref py py-class docutils literal notranslate"><span class="pre">FontDatabase</span></code>,
etc.) change. The <code class="xref py py-class docutils literal notranslate"><span class="pre">FontManager</span></code> singleton is loaded on-demand by the
first call to <code class="xref py py-func docutils literal notranslate"><span class="pre">default_font_manager()</span></code>.</p>
</div>
<div class="section" id="font-resolution">
<h2>Font Resolution<a class="headerlink" href="#font-resolution" title="Permalink to this headline">¶</a></h2>
<p>The <code class="xref py py-meth docutils literal notranslate"><span class="pre">findfont()</span></code> method uses a somewhat complex process for finding the
best match to a given font query.</p>
<ol class="arabic simple">
<li><p>If a <code class="docutils literal notranslate"><span class="pre">directory</span></code> keyword argument was passed, only fonts whose files are
children of <code class="docutils literal notranslate"><span class="pre">directory</span></code> will be checked. If none match, a default font is
returned.</p></li>
<li><p>If a <code class="docutils literal notranslate"><span class="pre">directory</span></code> is not specified, the search is first narrowed by the
font family (or families) designated by the query. This is possible because
the match scoring algorithm gives very bad scores to fonts whose family does
not match the query.</p></li>
<li><p>A score is computed for each font using the scoring functions
[<code class="xref py py-func docutils literal notranslate"><span class="pre">score_family()</span></code>, <code class="xref py py-func docutils literal notranslate"><span class="pre">score_size()</span></code>, <code class="xref py py-func docutils literal notranslate"><span class="pre">score_stretch()</span></code>,
<code class="xref py py-func docutils literal notranslate"><span class="pre">score_style()</span></code>, <code class="xref py py-func docutils literal notranslate"><span class="pre">score_variant()</span></code>, and
<code class="xref py py-func docutils literal notranslate"><span class="pre">score_weight()</span></code>]</p></li>
<li><p>If the score meets a certain threshold, the matching font is returned.
Otherwise a default is returned.</p></li>
<li><p>If the query was successful, it is added to a local query cache which will
avoid the scoring process if a matching query is later performed again.</p></li>
</ol>
</div>
<div class="section" id="adding-custom-fonts">
<span id="id2"></span><h2>Adding Custom Fonts<a class="headerlink" href="#adding-custom-fonts" title="Permalink to this headline">¶</a></h2>
<p>Because font resolution relies heavily on the system that the code is running
on, font matching may not always result in a good match for the desired font.
Kiva ships with a fallback font in case no matching font can be found (this
frequently happens on headless servers with no GUI libraries installed).
However developers may want to ensure that the fonts that they want are always
available by including the font files in the resources that are packaged with
their application.</p>
<p>Kiva provides <a class="reference internal" href="../api/kiva.fonttools.app_font.html#kiva.fonttools.app_font.add_application_fonts" title="kiva.fonttools.app_font.add_application_fonts"><code class="xref py py-func docutils literal notranslate"><span class="pre">add_application_fonts()</span></code></a> as a
mechanism to register additional fonts with the application font resolution
system.  This function should be called early in the application start-up
process with a list of paths of font files to add to the system.  These fonts
will also be added to the Qt and/or Wx font databases as well, as appropriate.</p>
<p>Typical usage might look something like the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">importlib.resources</span> <span class="kn">import</span> <span class="n">files</span>
<span class="kn">from</span> <span class="nn">kiva.fonttools.api</span> <span class="kn">import</span> <span class="n">add_application_fonts</span>

<span class="n">font_file_1</span> <span class="o">=</span> <span class="n">files</span><span class="p">(</span><span class="n">my_package</span><span class="o">.</span><span class="n">resources</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;my_font_1.ttf&quot;</span>
<span class="n">font_file_2</span> <span class="o">=</span> <span class="n">files</span><span class="p">(</span><span class="n">my_package</span><span class="o">.</span><span class="n">resources</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;my_font_2.ttf&quot;</span>

<span class="n">add_application_fonts</span><span class="p">([</span><span class="n">font_file_1</span><span class="p">,</span> <span class="n">font_file_2</span><span class="p">])</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The font files need to be actual files on the filesystem, they can’t be
stored in zip files.</p>
</div>
</div>
</div>


          </div>
        </div>
          </div>
      <div class="spc-rightsidebar span3">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/img/e-logo.png" alt="Logo">
            </a></p>
  <h3><a href="../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Kiva Font Management</a><ul>
<li><a class="reference internal" href="#overview">Overview</a></li>
<li><a class="reference internal" href="#font-resolution">Font Resolution</a></li>
<li><a class="reference internal" href="#adding-custom-fonts">Adding Custom Fonts</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="../api/kiva.trait_defs.ui.wx.kiva_font_editor.html"
                        title="previous chapter">kiva.trait_defs.ui.wx.kiva_font_editor module</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="writing_a_backend.html"
                        title="next chapter">Writing A Kiva Backend</a></p>
  <h3>This Page</h3>
  <div>
    <a href="../_sources/kiva/font_manager.rst.txt"
       rel="nofollow">Show Source</a>
  </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
        </div>
      </div>
    </div>

    <div class="container container-navbar-bottom">
      <div class="spc-navbar">
        
      </div>
    </div>
    <div class="container">
    <div class="footer">
    <div class="row-fluid">
    <ul class="inline pull-left">
      <li>
        &copy; Copyright 2005-2022 Enthought
      </li>
      <li>
      Last updated on Apr 28, 2022.
      </li>
      <li>
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 3.5.4.
      </li>
    </ul>
    </div>
    </div>
    </div>
  </body>
</html>